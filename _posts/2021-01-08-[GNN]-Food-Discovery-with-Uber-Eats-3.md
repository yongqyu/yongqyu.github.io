---
layout: post
category: develop
comments_id: 2
---
# [ : Using Graph Learning to Power Recommendations](https://eng.uber.com/uber-eats-graph-learning/)  
Uber Engineering Blog  
Ankit Jain, Isaac Liu, Ankur Sarda, and Piero Molino  
December 4, 2019

아래 글은 위 글의 비공식 약식 번역본 입니다.

*[previous post 1](https://yongqyu.github.io/gnn-food-discovery-with-uber-eats-1.html)*  
*[previous post 2](https://yongqyu.github.io/gnn-food-discovery-with-uber-eats-2.html)*

-----------------------------------------------------

### Data and training pipeline

우리가 그래프 러닝의 긍정적 영향을 확인 후, 우리는 프로덕션 환경의 실시간 예측과 모델 학습이 가능한 확장 가능한 파이프라인을 구축했다. 우리는 각 도시가 거의 연결되지 않아 따로 학습했다. 우리는 학습에 지난 몇달간의 익명화와 통합된 주문 데이터를 사용했고, 데이터를 networkx 그래프 포멧에 맞도록 4단계의 데이터 파이프라인을 디자인했다. 파이프라인은 또한 원본 주문 데이터에서 추출 가능한 특징 뿐 아니라 사용자가 주문한 전체 횟수와 같은 통합 정보도 추출한다. 게다가, 파이프라인은 오프라인 분석에 사용 가능한 주문 시간 프레임을 위한 그래프도 만들 수 있다. 전체적인 파이프라인은 아래 그림 6과 같다.:

![fig6](https://1fykyq3mdn5r21tpna3wkdyi-wpengine.netdna-ssl.com/wp-content/uploads/2019/12/image3-1.png)
*Figure 6: 향상된 인앱 음식, 식당 추천을 위한 GNN 베이스의 우버 이츠 추천 시스템을 위해, 우리는 윗줄 같은 데이터 파이프라인을 만들고, 아랫줄처럼 학습한다.*

파이프라인의 처음은, 여러 잡(jobs)들이 아파치 하이브 테이블로부터 데이터를 가져오고, 노드와 엣지 정보가 각각 포함된 파켓 형태의 파일로 HDFS에 쌓는 것이다. 각 노드와 엣지는 과거 데이터 구성을 위해 타임스탬프 별로 버저닝 된다.

두번째 단계는, 특정일 기준으로 가장 최근의 노드와 엣지를 취한 후 사이퍼 포맷으로 HDFS에 저장한다. 프로덕션 모델을 학습할때는 특정일이 현재이지만, 과거 일자가 정해진다고 해도 과정은 똑같다.

세번재 단계는, 아파치 스파크 실행 엔진에서 사이퍼 쿼리를 사용해 도시 별 구분된 여러개의 그래프를 생산하는 것이다.

마지막으로, 도시 그래프를 텐서플로우로 구현되고 gpu에서 실행되는 학습과 임베딩 생성에 사용되는 networkx 그래프 형태로 변환한다. 생성된 임베딩은 앱이 실행되고 추천이 요쳥될 때 탐색되는 lookup 테이블에 저장된다.

### Visualizing learned embeddings

그래프 러닝 알고리즘을 통한 학습의 특징을 예제로 보이기 위해, 우리는 시간에 따라 변하는 가상의 사용자를 제안한다. 새로운 사용자가 치킨 탄두리와 야채 비리아니를 우버 이츠에서 주문했다고 가정해보자. 이 사용자는 나중에 또 다른 음식들을 주문한다. : 하프 피자, 콥샐러드, 하프 더즌 도넛, 마파두부, 치킨 티카 마살라 그리고 갈릭 난. 우리는 이 추가 주문들 이후에 사용자의 표현을 얻고, 다른 종류의 식당들의 가장 인기있는 음식과의 거리를 계산한다. 이 결과를 [Parallax: Visualizing and Understanding the Semantics of Embedding Spaces via Algebraic Formulae](https://arxiv.org/abs/1905.12099)에서 제안하는 explicit axes technique를 사용해 그림 7과 같이 나타냈다.

![fig7](https://1fykyq3mdn5r21tpna3wkdyi-wpengine.netdna-ssl.com/wp-content/uploads/2019/12/image14.png)
*Figure 7: 우리는 가상의 사용자의 주문 전후를 비교했다. 또 사용자와 다른 음식점의 유명 음식과도 비교했다. 네 도면은 네가지 다른 종류의 식당들의 음식들을 하이라이트 했다. x축은 추가 주문 전 사용자와 음식들이 얼마나 가까워졌는지를 표시하며, y축은 추가 주문 후 비교이다.*

그림 7의 왼쪽 아래 표를 보면, 명확한 패턴이 보인다. 첫번째 패턴은 오른쪽 아래의 녹색 박스 하이라이트이다.: 추가 주문 전 사용자와 가장 가까운 음식들은 예상대로 대부분 인도 음식들(녹색 점)이다. 이는 첫 주문이 모두 인도 음식이었기 때문이다. 게다가 일부 중국 음식들도 x축에서 높은 순위를 차지하는데, 이는 이런 음식들의 2차 상관관계를 제안한다. 중국 음식들은 또한 y축에서도 상당히 높은 순위인데, 마파두부 주문이 모델에게 더 많은 중국 음식을 추천하게 한다.

그림 7의 오른쪽 위 영역은, 두번재 패턴을 오랜지색 박스로 하이라이트 했다.: 미국, 이탈리아, 타이 그리고 한국 음식들이 선택됐는데, 이는 사용자가 추가 주문 후 이 음식들과 얼마나 가까워졌는지를 보여준다. 이는 피자, 도넛 그리고 콥 샐러드 주문 때문이면서, 중국 음식 추천의 증가로 인한 두번째 주문 효과 때문이다. 중국 음식을 주문하는 사용자는 타이, 한국 음식을 주문할 확률 또한 높다.

마지막으로, 세번재 패턴이 파란색 박스로 하이라이트 된 왼쪽 위 영역은, 두 사용자 표현과 상위 3개의 음식에 포함되지 않은 모든 음식들은 후속 주문 후 유사도가 상승했다. 이는 모델이 이 특정 유저가 노출된 새로운 추천 음식을 좋아할지도 모른다고 학습했기 때문이다.

### Future directions

위에서 말한대로, 그래프 러닝은 주목할만한 연구 주제일 뿐 아니라, 이미 스케일 있는 추천시스템을 위한 설득력 있는 옵션이다. 그래프 러닝이 추천 퀄리티와 적절성의 가시적 향상을 가져오는데 반해, 우리는 여전히 기존 시스템 개발 작업도 수행했다. 특히, 우리는 음식과 식당 추천 시스템을 통합하는 방향으로 연구했다. 왜냐하면 우리는 서로에게 도움이 될거라 믿기 때문이다. 시간이 지나면서, 우리는 두개의 bipartite 그래프에서 모든 종류의 노드를 포함하는 하나의 싱글 그래프로의 전환을 계획하고 있다. 이 작업은 로스와 적절한 통합 함수 개발에 더 많은 작업이 필요로하지만, 이것이 공통된 정보를 활용하는 두가지 작업에 더 많은 정보를 제공할거라 생각한다.

우리가 다루고 싶은 다른 제약사항은 데이터 부족 상황에도 적절한 아이템을 추천하는 문제이다. 예를 들어, 우버 이츠가 처음 서비스하는 도시같은 경우이다. 우리는 메타 그래프 러닝 [^5] 을 통한 접근법을 구성중이다.


---
{: data-content="footnotes"}

[^5]: Joey Bose, Ankit Jain, Piero Molino and William L. Hamilton: Meta-Graph: Few shot Link Prediction via Meta-Learning. Graph Representation Learning Workshop @ NeurIPS 2019